ARG SECRET_DATABASE_URL
ARG SECRET_CLOUDINARY_CLOUD_NAME
ARG SECRET_CLOUDINARY_API_KEY
ARG SECRET_CLOUDINARY_API_SECRET
ARG PUBLIC_API_URL

FROM node:22-bullseye-slim AS builder

WORKDIR /app

COPY package*.json .
RUN npm i -g pnpm
RUN pnpm install

COPY . .

ENV SECRET_DATABASE_URL=${SECRET_DATABASE_URL}
ENV SECRET_CLOUDINARY_CLOUD_NAME=${SECRET_CLOUDINARY_CLOUD_NAME}
ENV SECRET_CLOUDINARY_API_KEY=${SECRET_CLOUDINARY_API_KEY}
ENV SECRET_CLOUDINARY_API_SECRET=${SECRET_CLOUDINARY_API_SECRET}
ENV PUBLIC_API_URL=${PUBLIC_API_URL}

RUN pnpm run build
RUN pnpm prune --prod

FROM builder AS prod

WORKDIR /app

COPY --from=builder /app/build build/
COPY --from=builder /app/package.json .

ENV SECRET_DATABASE_URL=${SECRET_DATABASE_URL}
ENV SECRET_CLOUDINARY_CLOUD_NAME=${SECRET_CLOUDINARY_CLOUD_NAME}
ENV SECRET_CLOUDINARY_API_KEY=${SECRET_CLOUDINARY_API_KEY}
ENV SECRET_CLOUDINARY_API_SECRET=${SECRET_CLOUDINARY_API_SECRET}
ENV PUBLIC_API_URL=${PUBLIC_API_URL}
ENV BODY_SIZE_LIMIT=10000000

EXPOSE 3000

CMD [ "node", "build" ]